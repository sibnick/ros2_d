# Build process

ROS2 ではメタビルドツールとして `colcon` が使われている。`coclon` の役割は、ワークスペースにある複数のパッケージの依存関係を解決してビルドの順番を制御するというものである。この時、それぞれのパッケージは必ずしも ROS2 パッケージ(ament パッケージ)である必要はないし、`source ./install/setup.sh` により環境変数の設定をしておけば、そのワークスペースの外に別のパッケージもビルドすることができる。そのため、本プロジェクトでは `source ./install/setup.bash` された状態を前提とし、 `dub` のみでビルドできるようにするのを基本とする。これは [r2r](https://github.com/sequenceplanner/r2r)を参考にした方法。

他方で `colcon` の仕組みに則ることも可能で、[colcon_d](https://github.com/nonanonno/colcon_d) を使えば `colcon` 経由で依存関係を解決し環境変数を設定した後、`dub` パッケージをビルドする、ということができると考えている。

ただし、全ての要素を ROS2 の外で行えるわけではなく、特にメッセージ定義は ROS2 のエコシステムから取得して、対応するDコードを生成する必要がある。

## Basic procedure

※デザイン段階のもので、今後変わる可能性あり

ビルドは以下の手順で行われる(これを自動化する)。

1. ユーザパッケージをビルドする前に、依存するメッセージを抽出する
    - これは `AMENT_PREFIX_PATH` などの環境変数を見ることになるかもしれない
    - メッセージの一覧を得る方法が必要
2. 依存するメッセージを dub パッケージ化する
    - これはユーザパッケージの `./.dub/packages` 以下に設置する
        - `dub fetch <pkg> --cache=local` 時に置かれる場所
    - メッセージの解釈には typesupport_introspection を使用する
        - .msg, .srv, .action, .idl を直接解釈するという方法でも良いかもしれない
3. ユーザパッケージをビルドする

## Development items

上記のビルドプロセスを実現するためには以下の要素が必要だろう。

- 依存するメッセージを取得する方法
- typesupport_introspection にアクセスする方法
- D言語向けメッセージパッケージを作る方法
    - これには D <-> C のメッセージオブジェクト変換も含まれる
